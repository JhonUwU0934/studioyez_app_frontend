<div class="container">
    <div class="container-left">
        <span (click)="doSomething()" class="back">
            <i class="fa-solid fa-arrow-left"></i>
        </span>
        <div class="page slide-page flash">

            <div class="form_header">
                <div class="form_title">
                    <h2>Agregar Venta</h2>
                </div>
            </div>

            <!-- SECCIÓN DE BÚSQUEDA DE PRODUCTOS -->
            <div class="input-content">
                <label class="label" for="">Buscar Producto</label>
                <input 
                    type="text" 
                    class="input" 
                    [(ngModel)]="codigoBuscado" 
                    placeholder="Ingresa el código de barras y presiona enter o escanea el código" 
                    (keyup.enter)="onEnterPressed()">
                
                <!-- MENSAJES DE ERROR -->
                <div *ngIf="valid" class="error-code">
                    <p>Has ingresado un código que no existe</p>
                </div>
                <div *ngIf="existProduct" class="error-code">
                    <p>Esta variante no tiene existencias en el almacén</p>
                </div>
                <div *ngIf="noVariantes" class="error-code">
                    <p>Este producto no tiene variantes configuradas</p>
                </div>
                <div *ngIf="cantidadExcedida" class="error-code">
                    <p>La cantidad solicitada excede el stock disponible</p>
                </div>
            </div>

            <!-- SECCIÓN DE SELECCIÓN DE VARIANTES -->
            <div *ngIf="productoEncontrado" class="variantes-selection">
                <div class="producto-encontrado">
                    <h3 class="producto-title">{{productoEncontrado.denominacion}}</h3>
                    <p class="producto-codigo">Código: {{productoEncontrado.codigo}}</p>
                </div>

                <div class="variantes-container">
                    <label class="label">Selecciona una variante:</label>
                    <div class="variantes-grid">
                        <div 
                            *ngFor="let variante of productoEncontrado.variantes" 
                            class="variante-card"
                            [class.selected]="varianteSeleccionada?.id === variante.id"
                            [class.no-stock]="variante.existente_en_almacen === 0"
                            (click)="onVarianteSelected(variante)">
                            
                            <div class="variante-info">
                                <div class="variante-header">
                                    <span class="variante-sku">{{variante.sku}}</span>
                                    <span class="variante-stock" 
                                          [class.stock-zero]="variante.existente_en_almacen === 0">
                                        Stock: {{variante.existente_en_almacen}}
                                    </span>
                                </div>
                                
                                <div class="variante-details">
                                    <span *ngIf="variante.color" class="variante-color">
                                        <i class="fa-solid fa-circle" [style.color]="variante.color.codigo_hex || '#ccc'"></i>
                                        {{variante.color.nombre}}
                                    </span>
                                    <span *ngIf="variante.talla" class="variante-talla">
                                        <i class="fa-solid fa-tag"></i>
                                        {{variante.talla.nombre}}
                                    </span>
                                </div>
                                
                                <div class="variante-precio">
                                    ${{getVariantePrecio(variante) | customNumber}}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NUEVA SECCIÓN: CANTIDAD A AGREGAR -->
                    <div *ngIf="varianteSeleccionada" class="cantidad-section">
                        <div class="cantidad-input-container">
                            <label class="label">Cantidad:</label>
                            <div class="cantidad-controls">
                                <button 
                                    type="button" 
                                    class="btn-cantidad" 
                                    (click)="decrementarCantidad()"
                                    [disabled]="cantidadAAgregar <= 1">
                                    <i class="fa-solid fa-minus"></i>
                                </button>
                                <input 
                                    type="number" 
                                    class="input-cantidad" 
                                    [(ngModel)]="cantidadAAgregar"
                                    [min]="1"
                                    [max]="getMaxCantidadDisponible()"
                                    (input)="onCantidadInputChange()"
                                    (blur)="validarCantidad()">
                                <button 
                                    type="button" 
                                    class="btn-cantidad" 
                                    (click)="incrementarCantidad()"
                                    [disabled]="cantidadAAgregar >= getMaxCantidadDisponible()">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                            <small class="cantidad-info">
                                Disponible: {{getMaxCantidadDisponible()}} | 
                                Total: ${{(getVariantePrecio(varianteSeleccionada) * cantidadAAgregar) | customNumber}}
                            </small>
                        </div>
                    </div>

                    <div class="variante-actions">
                        <button 
                            type="button"
                            class="btn-agregar"
                            [disabled]="!varianteSeleccionada || varianteSeleccionada.existente_en_almacen === 0 || cantidadAAgregar > getMaxCantidadDisponible()"
                            (click)="onAgregarProducto()">
                            <i class="fa-solid fa-plus"></i>
                            Agregar {{cantidadAAgregar || 1}} al carrito
                        </button>
                        <button 
                            type="button"
                            class="btn-cancelar"
                            (click)="resetSelection()">
                            <i class="fa-solid fa-times"></i>
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <!-- TOTAL -->
            <p class="label-title">Total: ${{total() | customNumber}}</p>

            <!-- TABLA DE PRODUCTOS AGREGADOS -->
            <div *ngIf="productosFiltrados.length > 0" class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>SKU</th>
                            <th>Color</th>
                            <th>Talla</th>
                            <th>Stock</th>
                            <th>Cantidad</th>
                            <th>Descuento</th>
                            <th>Precio Unit.</th>
                            <th>Total</th>
                            <th>Eliminar</th>
                        </tr>
                    </thead>
                    <tbody *ngFor="let data of productosFiltrados | paginate: { itemsPerPage: 5, currentPage: p }; let i = index">
                        <tr>
                            <td>
                                <div class="producto-cell">
                                    <strong>{{data.denominacion}}</strong>
                                    <small>{{data.codigo}}</small>
                                </div>
                            </td>
                            <td><span class="sku-badge">{{data.sku_variante}}</span></td>
                            <td>
                                <span *ngIf="data.color_nombre" class="color-info">
                                    <i class="fa-solid fa-circle" 
                                       [style.color]="data.variante_seleccionada?.color?.codigo_hex || '#ccc'"></i>
                                    {{data.color_nombre}}
                                </span>
                                <span *ngIf="!data.color_nombre" class="no-info">-</span>
                            </td>
                            <td>
                                <span *ngIf="data.talla_nombre" class="talla-badge">{{data.talla_nombre}}</span>
                                <span *ngIf="!data.talla_nombre" class="no-info">-</span>
                            </td>
                            <td>
                                <span class="stock-info" 
                                      [class.stock-low]="data.stock_disponible < 5">
                                    {{data.stock_disponible}}
                                </span>
                            </td>
                            <td>
                                <input 
                                    class="input-quantiti" 
                                    style="width: 60px;" 
                                    type="number" 
                                    min="1"
                                    [max]="data.stock_disponible"
                                    [(ngModel)]="quantities[i]" 
                                    (input)="onCantidadChange(data,i)">
                            </td>
                            <td>
                                <input 
                                    class="input-quantiti" 
                                    style="width: 100px;" 
                                    type="text" 
                                    placeholder="Descuento..." 
                                    [(ngModel)]="porcentaje[i]" 
                                    (input)="onPorcentajeChange(data,i)" 
                                    appFormatoNumerico>
                                <small>$</small>
                            </td>
                            <td>${{data.precio_por_unidad | customNumber}}</td>
                            <td><strong>${{data.total | customNumber}}</strong></td>
                            <td>
                                <button 
                                    type="button"
                                    class="btn-delete"
                                    (click)="onDeleteProducto(data)">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- PAGINACIÓN -->
            <pagination-controls
                *ngIf="productosFiltrados.length > 5"
                class="my-pagination"
                [directionLinks]="false"
                (pageChange)="p = $event"
                previousLabel="Anterior"
                nextLabel="Siguiente"
                [maxSize]="5"
                [responsive]="true">
            </pagination-controls>

            <!-- FORMULARIO DE VENTA -->
            <form *ngIf="isItemsArrayValid()" (ngSubmit)="getSubmit()" [formGroup]="saleForm" class="sale-form">
                <div class="form-header-section">
                    <h3>Información del Cliente</h3>
                </div>

                <div class="content-inputs">
                    <app-input [form]="saleForm" [arrayInput]="arrayInput1"></app-input>
                    <app-input [form]="saleForm" [arrayInput]="arrayInput2"></app-input>
                </div>

                <!-- NUEVA SECCIÓN: PAGO COMBINADO + CRÉDITO -->
                <div class="pago-combinado-section">
                    <div class="form-header-section">
                        <h3>Métodos de Pago</h3>
                        <p class="pago-subtitle">El cliente puede pagar con efectivo, transferencia, crédito o combinando métodos</p>
                    </div>
                    
                    <div class="pago-grid">
                        <!-- EFECTIVO -->
                        <div class="pago-method-card efectivo">
                            <div class="method-header">
                                <div class="method-icon">
                                    <i class="fa-solid fa-money-bills"></i>
                                </div>
                                <h4>Efectivo</h4>
                            </div>
                            <div class="method-input">
                                <div class="input-container">
                                    <span class="currency">$</span>
                                    <input 
                                        type="number" 
                                        formControlName="valor_efectivo"
                                        class="payment-input"
                                        [min]="0"
                                        step="0.01"
                                        placeholder="0.00"
                                        (input)="onValorEfectivoChange()">
                                </div>
                            </div>
                        </div>

                        <!-- TRANSFERENCIA -->
                        <div class="pago-method-card transferencia">
                            <div class="method-header">
                                <div class="method-icon">
                                    <i class="fa-solid fa-credit-card"></i>
                                </div>
                                <h4>Transferencia</h4>
                            </div>
                            <div class="method-input">
                                <div class="input-container">
                                    <span class="currency">$</span>
                                    <input 
                                        type="number" 
                                        formControlName="valor_transferencia"
                                        class="payment-input"
                                        [min]="0"
                                        step="0.01"
                                        placeholder="0.00"
                                        (input)="onValorTransferenciaChange()">
                                </div>
                            </div>
                        </div>

                        <!-- CRÉDITO -->
                        <div class="pago-method-card credito">
                            <div class="method-header">
                                <div class="method-icon">
                                    <i class="fa-solid fa-calendar-alt"></i>
                                </div>
                                <h4>Crédito</h4>
                            </div>
                            <div class="method-input">
                                <div class="input-container">
                                    <span class="currency">$</span>
                                    <input 
                                        type="number" 
                                        formControlName="valor_credito"
                                        class="payment-input"
                                        [min]="0"
                                        step="0.01"
                                        placeholder="0.00"
                                        (input)="onValorCreditoChange()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FECHA DE PROMESA (solo si hay crédito) -->
                    <div *ngIf="valorCredito > 0" class="fecha-promesa-section">
                        <div class="fecha-promesa-container">
                            <label class="label">Fecha de promesa de pago:</label>
                            <input 
                                type="date" 
                                formControlName="fecha_promesa_pago"
                                class="fecha-input"
                                [min]="getFechaMinima()"
                                [max]="getFechaMaxima()"
                                (change)="onFechaPromesaChange()">
                            <small class="fecha-info">
                                El cliente se compromete a pagar el crédito en esta fecha
                            </small>
                        </div>
                    </div>

                    <!-- RESUMEN DE PAGO -->
                    <div class="pago-summary">
                        <div class="summary-row total-venta">
                            <span class="label">Total de la venta:</span>
                            <span class="value total">${{total() | customNumber}}</span>
                        </div>
                        
                        <div class="summary-row total-pagado">
                            <span class="label">Total comprometido:</span>
                            <span class="value pagado" [class.insuficiente]="pagoInsuficiente">
                                ${{totalPagado() | customNumber}}
                            </span>
                        </div>

                        <div *ngIf="getTotalRestante() > 0" class="summary-row restante">
                            <span class="label">Falta por comprometer:</span>
                            <span class="value falta">${{getTotalRestante() | customNumber}}</span>
                        </div>

                        <div *ngIf="valorDevuelto() > 0" class="summary-row cambio">
                            <span class="label">Cambio a devolver:</span>
                            <span class="value cambio-amount">${{valorDevuelto() | customNumber}}</span>
                        </div>

                        <!-- MENSAJE DE ERROR -->
                        <div *ngIf="pagoInsuficiente" class="error-code">
                            <p>El total comprometido es insuficiente para completar la venta</p>
                        </div>

                        <!-- NUEVO: Errores de validación del formulario -->
                        <div *ngIf="saleForm.hasError('pagoInsuficiente')" class="error-code">
                            <p>El total comprometido debe ser mayor o igual al total de la venta</p>
                        </div>

                        <div *ngIf="saleForm.hasError('noProductos')" class="error-code">
                            <p>Debe agregar productos al carrito antes de procesar el pago</p>
                        </div>

                        <div *ngIf="saleForm.hasError('fechaPromesaRequerida')" class="error-code">
                            <p>Debe especificar la fecha de promesa de pago para ventas a crédito</p>
                        </div>

                        <div *ngIf="saleForm.hasError('fechaPromesaInvalida')" class="error-code">
                            <p>La fecha de promesa de pago debe ser una fecha futura</p>
                        </div>

                        <div *ngIf="saleForm.hasError('fechaPromesaMuyLejana')" class="error-code">
                            <p>El crédito no puede exceder 6 meses</p>
                        </div>
                    </div>

                    <!-- BOTONES DE ACCESO RÁPIDO -->
                    <div class="quick-payment-buttons">
                        <button 
                            type="button" 
                            class="quick-btn solo-efectivo"
                            (click)="pagarSoloEfectivo()">
                            <i class="fa-solid fa-money-bills"></i>
                            Solo Efectivo
                        </button>
                        <button 
                            type="button" 
                            class="quick-btn solo-transferencia"
                            (click)="pagarSoloTransferencia()">
                            <i class="fa-solid fa-credit-card"></i>
                            Solo Transferencia
                        </button>
                        <button 
                            type="button" 
                            class="quick-btn solo-credito"
                            (click)="pagarSoloCredito()">
                            <i class="fa-solid fa-calendar-alt"></i>
                            Solo Crédito
                        </button>
                        <button 
                            type="button" 
                            class="quick-btn mitad-mitad"
                            (click)="pagarMitadMitad()">
                            <i class="fa-solid fa-arrows-split-up-and-left"></i>
                            50% - 50%
                        </button>
                    </div>
                </div>

                <div class="form-summary">
                    <div class="summary-item">
                        <span>Productos diferentes:</span>
                        <strong>{{productosFiltrados.length}}</strong>
                    </div>
                    <div class="summary-item">
                        <span>Cantidad total:</span>
                        <strong>{{calcularCantidadTotal()}}</strong>
                    </div>
                    <div class="summary-item total-final">
                        <span>Total final:</span>
                        <strong>${{total() | customNumber}}</strong>
                    </div>
                </div>

                <div class="form-button">
                    <app-button 
                        [label]="'Generar venta'" 
                        [myForm]="saleForm">
                    </app-button>
                </div>
            </form>

            <!-- MENSAJE CUANDO NO HAY PRODUCTOS -->
            <div *ngIf="!isItemsArrayValid() && !productoEncontrado" class="empty-cart">
                <div class="empty-icon">
                    <i class="fa-solid fa-shopping-cart"></i>
                </div>
                <h3>Carrito vacío</h3>
                <p>Busca productos por código de barras para comenzar</p>
            </div>
        </div>
    </div>
</div>