<div class="container">

    <div class="products-header">
        <div class="products-header_pruduct">
            <span><i class="fa-solid fa-scale-unbalanced"></i></span>
            <p>Registro de ventas</p>
            <p>Ingresa y edita las ventas</p>
        </div>
    </div>

    <div>
        <div class="product-movements">
            <app-button-click label="Generar Venta" [buttonMethod]="doSomething"></app-button-click>

            <div class="input-content">
                <label class="label" for="busqueda">Buscar:</label>
                <input class="input" id="busqueda" [(ngModel)]="search" placeholder="Ingresa el código de factura">
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Productos</th>
                            <th>Vendedor</th>
                            <th>Estado / Crédito</th>
                            <th>Factura</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let data of (data.data | searchSale:'codigo_factura': search | paginate: { itemsPerPage: 5, currentPage: p })"
                            [class.credito-pendiente]="creditoPendiente(data)"
                            [class.credito-vencido]="creditoVencido(data)"
                            [class.credito-pagado]="creditoPagado(data)"
                            [class.credito-por-vencer]="creditoPendiente(data) && getDiasRestantesCredito(data) <= 3 && !creditoVencido(data)">
                            
                            <!-- FECHA -->
                            <td>
                                <div class="fecha-cell">
                                    <span class="date">
                                        <i class="fa-solid fa-calendar"></i>
                                    </span>
                                    <div class="fecha-info">
                                        <div class="fecha-principal">{{data.created_at | date:'dd/MM/yyyy'}}</div>
                                        <div class="fecha-hora">{{data.created_at | date:'HH:mm'}}</div>
                                    </div>
                                </div>
                            </td>

                            <!-- CLIENTE -->
                            <td>
                                <div class="cliente-cell">
                                    <div class="cliente-nombre">{{data.nombre_comprador}}</div>
                                    <div class="cliente-telefono">{{data.numero_comprador}}</div>
                                    <div class="codigo-factura">{{data.codigo_factura}}</div>
                                </div>
                            </td>

                            <!-- TOTAL -->
                            <td>
                                <div class="total-cell">
                                    <div class="precio-principal">${{data.precio_venta | customNumber}}</div>
                                    <div class="descuentos" *ngIf="getTotalDescuentos(data) > 0">
                                        Desc: ${{getTotalDescuentos(data) | customNumber}}
                                    </div>
                                    <div class="badge-variantes" *ngIf="esVentaConVariantes(data)">
                                        <i class="fa-solid fa-tags"></i> Con variantes
                                    </div>
                                    <!-- Badge de crédito -->
                                    <div *ngIf="tieneCredito(data)" class="badge-credito" 
                                         [class.credito-pendiente-badge]="creditoPendiente(data)"
                                         [class.credito-pagado-badge]="creditoPagado(data)"
                                         [class.credito-vencido-badge]="creditoVencido(data)">
                                        <i class="fa-solid fa-credit-card"></i> 
                                        ${{parseFloat(data.valor_credito || '0') | customNumber}}
                                    </div>
                                </div>
                            </td>

                            <!-- PRODUCTOS -->
                            <td class="productos-column">
                                <div class="productos-container">
                                    <!-- Resumen de productos -->
                                    <div class="productos-resumen">
                                        <span class="total-productos">
                                            {{getTotalProductosDiferentes(data)}} producto(s) |
                                            {{getTotalProductos(data)}} unidad(es)
                                        </span>
                                    </div>

                                    <!-- Lista detallada de productos -->
                                    <div class="productos-detalle">
                                        <div *ngFor="let item of data.productos; let i = index" 
                                             class="producto-item"
                                             [class.con-variante]="tieneVariante(item)">
                                            
                                            <!-- Información básica del producto -->
                                            <div class="producto-header">
                                                <div class="producto-nombre">
                                                    <i class="fa-solid fa-box" *ngIf="!tieneVariante(item)"></i>
                                                    <i class="fa-solid fa-tags" *ngIf="tieneVariante(item)"></i>
                                                    {{item.denominacion | textFilter}}
                                                </div>
                                                <div class="producto-codigo">{{item.codigo}}</div>
                                            </div>

                                            <!-- Información de variante (si existe) -->
                                            <div *ngIf="tieneVariante(item)" class="variante-info">
                                                <span class="sku-badge">{{item.pivot.sku_vendido}}</span>
                                            </div>

                                            <!-- Información de precios y cantidad -->
                                            <div class="producto-detalles">
                                                <div class="cantidad-precio">
                                                    <span class="cantidad">Cant: {{item.pivot.cantidad}}</span>
                                                    <span class="precio-unitario">
                                                        ${{getPrecioUnitarioFormateado(item) | customNumber}}
                                                    </span>
                                                </div>
                                                
                                                <div class="total-descuento">
                                                    <span class="total-producto">
                                                        Total: ${{item.pivot.total_producto | customNumber}}
                                                    </span>
                                                    <span *ngIf="tieneDescuento(item.pivot.descuento)" class="descuento">
                                                        Desc: ${{item.pivot.descuento | customNumber}}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Expandir/contraer si hay muchos productos -->
                                    <div *ngIf="data.productos.length > 3" class="productos-toggle">
                                        <button type="button" class="btn-toggle">
                                            <i class="fa-solid fa-chevron-down"></i>
                                            Ver todos ({{data.productos.length}})
                                        </button>
                                    </div>
                                </div>
                            </td>

                            <!-- VENDEDOR -->
                            <td>
                                <div class="vendedor-cell">
                                    <i class="fa-solid fa-user"></i>
                                    {{data.vendedor.name}}
                                </div>
                            </td>

                            <!-- ESTADO / CRÉDITO -->
                            <td>
                                <div class="estado-cell">
                                    <!-- Estado de pago tradicional -->
                                    <div *ngIf="data.estado_pago === '1' && !tieneCredito(data)" class="estado-activo">
                                        <i class="fa-solid fa-check-circle"></i>
                                        Pagada
                                    </div>
                                    <div *ngIf="(!data.estado_pago || data.estado_pago !== '1') && !tieneCredito(data)" class="estado-pendiente">
                                        <i class="fa-solid fa-clock"></i>
                                        Pendiente
                                    </div>

                                    <!-- Estados de crédito -->
                                    <div *ngIf="creditoPagado(data)" class="estado-credito-pagado">
                                        <i class="fa-solid fa-check-double"></i>
                                        <span>Crédito Pagado</span>
                                        <small>${{parseFloat(data.valor_credito || '0') | customNumber}}</small>
                                    </div>

                                    <div *ngIf="creditoPendiente(data)" class="estado-credito-pendiente">
                                        <i class="fa-solid fa-credit-card"></i>
                                        <span>Crédito Pendiente</span>
                                        <small>${{parseFloat(data.valor_credito || '0') | customNumber}}</small>
                                        
                                        <!-- Información de vencimiento -->
                                        <div class="credito-vencimiento">
                                            <div *ngIf="creditoVencido(data)" class="vencido">
                                                <i class="fa-solid fa-exclamation-triangle"></i>
                                                ¡VENCIDO!
                                            </div>
                                            <div *ngIf="!creditoVencido(data) && getDiasRestantesCredito(data) <= 3" class="por-vencer">
                                                <i class="fa-solid fa-clock"></i>
                                                Vence en {{getDiasRestantesCredito(data)}} día(s)
                                            </div>
                                            <div *ngIf="!creditoVencido(data) && getDiasRestantesCredito(data) > 3" class="vigente">
                                                <i class="fa-solid fa-calendar-check"></i>
                                                {{getDiasRestantesCredito(data)}} días restantes
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Estado mixto (pago parcial + crédito) -->
                                    <div *ngIf="tienePagoMixto(data)" class="estado-mixto">
                                        <div class="pago-info">
                                            <span *ngIf="tieneValorEfectivo(data)" class="efectivo-badge">
                                                Efec: ${{parseFloat(data.valor_efectivo || '0') | customNumber}}
                                            </span>
                                            <span *ngIf="tieneValorTransferencia(data)" class="transferencia-badge">
                                                Trans: ${{parseFloat(data.valor_transferencia || '0') | customNumber}}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </td>

                            <!-- FACTURA -->
                            <td>
                                <div class="factura-cell">
                                    <div *ngIf="data.estado_pago === '1'; else template1" class="factura-disponible">
                                        <a target="_blank" [href]="data.url_factura" class="btn-factura">
                                            <i class="fa-solid fa-file-invoice"></i>
                                            Ver Factura
                                        </a>
                                    </div>
                                    <ng-template #template1>
                                        <div class="factura-pendiente">
                                            <button 
                                                [class.loading]="data.loading" 
                                                class="action-btn" 
                                                (click)="activateSale(data.id, data)"
                                                [disabled]="data.loading">
                                                <i *ngIf="!data.loading" class="fa-solid fa-play"></i>
                                                Activar Venta
                                            </button>
                                        </div>
                                    </ng-template>
                                </div>
                            </td>

                            <!-- ACCIONES -->
                            <td>
                                <div class="acciones-cell">
                                    <!-- Botón ver detalle -->
                                    <button 
                                        type="button"
                                        class="btn-accion btn-detalle"
                                        (click)="verDetalleVenta(data)"
                                        title="Ver información detallada">
                                        <i class="fa-solid fa-eye"></i>
                                    </button>

                                    <!-- Botón pagar crédito (solo si tiene crédito pendiente) -->
                                    <button 
                                        *ngIf="creditoPendiente(data)"
                                        type="button"
                                        class="btn-accion btn-pagar-credito"
                                        [class.btn-vencido]="creditoVencido(data)"
                                        (click)="pagarCredito(data)"
                                        [title]="'Marcar crédito como pagado ($' + (parseFloat(data.valor_credito || '0') | customNumber) + ')'">
                                        <i class="fa-solid fa-dollar-sign"></i>
                                    </button>

                                    <!-- Indicador de crédito pagado -->
                                    <span 
                                        *ngIf="creditoPagado(data)"
                                        class="credito-pagado-indicator"
                                        title="Crédito ya pagado">
                                        <i class="fa-solid fa-check-circle"></i>
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- INFORMACIÓN ADICIONAL SOBRE LAS VENTAS -->
            <div class="ventas-estadisticas" *ngIf="data.data.length > 0">
                <div class="estadistica-item">
                    <i class="fa-solid fa-receipt"></i>
                    <span>Total ventas: {{data.data.length}}</span>
                </div>
                <div class="estadistica-item">
                    <i class="fa-solid fa-tags"></i>
                    <span>Con variantes: {{contarVentasConVariantes()}}</span>
                </div>
                <div class="estadistica-item">
                    <i class="fa-solid fa-dollar-sign"></i>
                    <span>Total vendido: ${{calcularTotalVendido() | customNumber}}</span>
                </div>
                <!-- Estadística de créditos -->
                <div class="estadistica-item" *ngIf="tieneAlgunaVentaConCredito()">
                    <i class="fa-solid fa-credit-card"></i>
                    <span>Con crédito: {{contarVentasConCredito()}}</span>
                </div>
                <div class="estadistica-item" *ngIf="tieneAlgunaVentaConCreditoPendiente()">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <span>Créditos pendientes: {{contarVentasConCreditoPendiente()}}</span>
                </div>
            </div>

            <!-- PAGINACIÓN -->
            <pagination-controls 
                class="my-pagination"
                [directionLinks]="false"
                (pageChange)="p = $event" 
                previousLabel="Anterior"
                nextLabel="Siguiente"  
                [maxSize]="5" 
                [responsive]="true">
            </pagination-controls>

        </div>
    </div>

</div>